---
title: "clean_data"
author: "Austin Kennedy"
date: "1/12/2022"
output: html_document
---

```{r Clear memory and setup}
rm(list=ls())
options(scipen=999)
```

```{r Load Packages}
library(tidyverse)
```

```{r Load Data}
# odi1 <- read.csv("../Input/ODI/ODI_1996-2001.csv")
# odi2 <- read.csv("../Input/ODI/ODI_2002-2011.csv")
odi <- read.csv("../Input/ODI/ODI_2002-2011.csv")
fdi <- read.csv("../Input/fdi_country_industry.csv", nrows = 67, na.strings = "n.s.", check.names = FALSE)
#fdi <- read.csv("../Input/us_inward_country.csv", nrows = 65, na.strings = "n.s.", check.names = FALSE)
```

# ```{r Change variable names to match}
# odi1 <- odi1 %>% rename(EMP_Q1 = Q1,
#                         HOURS_Q2 = Q2,
#                         UNUSUAL_Q3 = Q3A,
#                         STRIKE_Q3 = Q3B,
#                         SHUT_Q3 = Q3C,
#                         SEASONAL_Q3 = Q3D,
#                         DISASTER_Q3 = Q3E,
#                         SHORT_Q3 = Q3F,
#                         LONG_Q3 = Q3G,
#                         OREASON_Q3 = Q3H,
#                         )
# ```

```{r Clean FDI data}
# fdi <- fdi[,-2] #Second column is the same as the first, but with spacing
colnames(fdi)[1] = "Country"
fdi <- fdi[rowSums(is.na(fdi)) != (ncol(fdi)-1),] #take out rows that have all NAs
fdi$Country <- trimws(fdi$Country) #Remove whitespace
fdi <- fdi[!(fdi$Country %in% c("Addenda:", "Other")),]  #Remove rows that aren't useful
fdi[fdi == "(D)"] <- NA #(D) represents confidential values in the source data
fdi[fdi == "(*)"] <- 0 #(*) represents close to zero in the source data

years <- as.numeric(fdi[2,])
industries <- colnames(fdi)

#Function to insert row
insertRow <- function(existingDF, newrow, r) {
  existingDF[seq(r+1,nrow(existingDF)+1),] <- existingDF[seq(r,nrow(existingDF)),]
  existingDF[r,] <- newrow
  existingDF
}

fdi <- insertRow(fdi, industries, 1) #Insert colnames as a row to not be lost
colnames(fdi) <- years #Change col names to years for wide to long transition

fdi <- t(fdi) #transpose
#Change col names to countries
countries <- fdi[1,] 
colnames(fdi) <- countries
fdi <- fdi[-1,]

colnames(fdi)[1:3] = c("title_2", "title_3", "Year")
rownames(fdi) <- NULL
fdi <- as_tibble(fdi)
# fdi <- fdi %>% pivot_longer(-c("title_2", "title_3", "Year"), names_to = "Country", values_to = "fdi") #Wide to long
```

```{r Match NAICS codes to fdi industries}
naics <- read.csv("../Input/naics07.csv")
naics <- naics[-1,-1]
colnames(naics) <- c("code", "title_3")
naics <- as_tibble(naics)
naics <- subset(naics, nchar(naics$code) <= 5)
# new <- merge(fdi, naics, by = "title_3")

library(fuzzyjoin)

new <- stringdist_join(fdi, naics,
                by = "title_3",
                mode = "left",
                ignore_case = TRUE,
                method = "jw",
                max_dist = 99,
                distance_col = "dist") %>%
  group_by(title_3.x) %>%
  slice_min(order_by = dist, n = 1)

new <- new[, c("title_2", "title_3.x", "code", "title_3.y", "dist")]
uni <- distinct(new, title_3.x, title_3.y, .keep_all = TRUE)
#Manually recode unmatched industries, probably not best practice but best I can do
uni <- uni %>% mutate(industry = case_when(title_3.x == "All Industries Total" ~ "All Industries Total",
                                           title_3.x == "Depository Institutions" ~ "Credit Intermediation and Related Activities",
                                           title_3.x == "Finance (except depository institutions) and insurance" ~ "Finance and Insurance",
                                           title_3.x == "Other Industries" ~ "Other Industries",
                                           title_3.x == "Other Manufacturing" ~ "Manufacturing",
                                           title_3.x == "Total Manufacturing" ~ "Manufacturing",
                                           TRUE ~ title_3.y))
uni <- merge(uni, naics, by.x = "industry", by.y = "title_3")
fdi <- merge(fdi, uni[, c("code.y","title_3.x")], by.x = "title_3", by.y = "title_3.x", all.x = TRUE)
fdi <- rename(fdi, code = code.y)
# fdi <- fdi[, c("title_2", "title_3", "code", "Year", "Country", "fdi")]
fdi <- fdi %>% select("title_2", "title_3", "code", everything())
```

```{r Merge FDI and firm data}
#Create two and three digit naics for each firm
odi <- odi %>%
  mutate(naics_2 = as.numeric(substr(NAICS, 1, 2)),
         naics_3 = as.numeric(substr(NAICS, 1, 3)),
         .before = "EMP_Q1")

odi <- odi %>%
  drop_na(NAICS)
#Two part merge, first is 3-digit
merge_1 <- merge(odi, fdi, by.x = c("Year","naics_3"), by.y = c("Year","code"))

```

```{r test regs}
library(fixest)
merge_1 <- merge_1 %>% mutate(tcr = (INJ_M1*200000) / HOURS_Q2,
                              .before = "EMP_Q1")
merge_1 <- rename(merge_1, fdi_total = `All Countries Total`)
merge_1$fdi_total <- as.numeric(merge_1$fdi_total)
model_1 <- feols(tcr ~ fdi_total, merge_1)
model_2 <- feols(tcr ~ fdi_total|STREET + Year, merge_1)
model_3 <- feols(log(tcr) ~ log(fdi_total)|STREET + Year, merge_1)
summary(model_3)
    ```

```{r Scatterplot}
ggplot(merge_1, aes(x=fdi_total, y=tcr)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE)
```

```{r Fuzzy matching if data is long}
# naics <- read.csv("../Input/naics07.csv")
# naics <- naics[-1,-1]
# colnames(naics) <- c("code", "title_3")
# naics <- as_tibble(naics)
# naics <- subset(naics, nchar(naics$code) <= 5)
# # new <- merge(fdi, naics, by = "title_3")
# library(fuzzyjoin)
# new <- stringdist_join(fdi, naics,
#                 by = "title_3",
#                 mode = "left",
#                 ignore_case = TRUE,
#                 method = "jw",
#                 max_dist = 99,
#                 distance_col = "dist") %>%
#   group_by(title_3.x) %>%
#   slice_min(order_by = dist, n = 1)
# uni <- distinct(new, title_3.x, title_3.y, .keep_all = TRUE)
# #Manually recode unmatched industries, probably not best practice but best I can do
# uni <- uni %>% mutate(industry = case_when(title_3.x == "All Industries Total" ~ "All Industries Total",
#                                            title_3.x == "Depository Institutions" ~ "Credit Intermediation and Related Activities",
#                                            title_3.x == "Finance (except depository institutions) and insurance" ~ "Finance and Insurance",
#                                            title_3.x == "Other Industries" ~ "Other Industries",
#                                            title_3.x == "Other Manufacturing" ~ "Manufacturing",
#                                            title_3.x == "Total Manufacturing" ~ "Manufacturing",
#                                            TRUE ~ title_3.y))
# uni <- merge(uni, naics, by.x = "industry", by.y = "title_3")
# fdi <- merge(fdi, uni[, c("code.y","title_3.x")], by.x = "title_3", by.y = "title_3.x", all.x = TRUE)
# fdi <- rename(fdi, code = code.y)
# fdi <- fdi[, c("title_2", "title_3", "code", "Year", "Country", "fdi")]
```





```{r Create Plant IDs}
#Using street addresses because want to identify individual plants instead of firms
odi <- odi %>%
  group_by(STREET) %>%
  mutate(ID = cur_group_id())

#check no. of unique IDs
length(unique(odi[["ID"]]))
```

```{r Test code}
uni <- distinct(new, title_3.x, title_3.y)
```


















