---
title: "clean_data"
author: "Austin Kennedy"
date: "1/12/2022"
output: html_document
---

```{r Clear memory and setup}
rm(list=ls())
options(scipen=999)
```

```{r Load Packages}
library(tidyverse)
library(fixest)
library(modelsummary)
library(kableExtra)
library(lubridate)
```

```{r Load Data}
odi_ind <- read.csv("../Temporary/odi_fdi.csv")
# odi_fdi_safety <- read.csv("../Temporary/odi_fdi_safety.csv")
# odi_source <- read.csv("../Temporary/odi_fdi_source.csv")
odi_plant <- read.csv("../Temporary/odi_plant.csv")
```

```{r Industry-detailed regressions}
mod1 <- feols(tcr ~ log(fdi),odi_ind)
mod2 <- feols(tcr ~ log(fdi)|Year, odi_ind)
mod3 <- feols(tcr ~ log(fdi)|Year + industry, odi_ind)
mod4 <- feols(tcr ~ log(fdi_tot), odi_plant)
mod5 <- feols(tcr ~ log(fdi_tot)|Year, odi_plant)
mod6 <- feols(tcr ~ log(fdi_tot)|Year + naics_3, odi_plant)
ind_models <- list(mod1, mod2, mod3, mod4, mod5, mod6)
```

```{r Weighted Avg Regressions}
wa_mod1 <- feols(tcr ~ log(fdi_tot) + log(fdi_tot)*weight_avg, odi_plant)
wa_mod2 <- feols(tcr ~ log(fdi_tot) + log(fdi_tot)*weight_avg|Year, odi_plant)
wa_mod3 <- feols(tcr ~ log(fdi_tot) + log(fdi_tot)*weight_avg|Year + naics_3, odi_plant)
wa_mod4 <- feols(tcr ~ log(fdi_tot) + log(fdi_tot)*weight_avg|naics_3, odi_plant)

wa_models <- list(wa_mod1, wa_mod2, wa_mod3, wa_mod4)
```

```{r Interaction Regressions}
# mod1 <- feols(tcr ~ asinh(fdi)|Year, odi_ind, vcov = "twoway")
# mod2 <- feols(tcr ~ asinh(fdi)|Year + industry, odi_ind, vcov = "twoway")
# mod3 <- feols(tcr ~ asinh(fdi) + asinh(fdi)*inj_foreign, odi_source)
# mod4 <- feols(tcr ~ asinh(fdi) + asinh(fdi)*inj_foreign|Year, odi_source, vcov = "twoway")
# mod5 <- feols(tcr ~ asinh(fdi) + asinh(fdi)*inj_foreign|Year + naics_3, odi_source, vcov = "twoway")
```
```{r Summation Interaction}
# mod6 <- feols(tcr ~ asinh(fdi_tot) + asinh(int_sum), odi_sum)
# mod7 <- feols(tcr ~ asinh(fdi_tot) + asinh(int_sum)|Year, odi_sum)
# mod8 <- feols(tcr ~ asinh(fdi_tot) + asinh(int_sum)|Year + naics_3, odi_sum)
```

```{r Table 2}
modelsummary(ind_models,
             stars = TRUE,
             output = "markdown")

modelsummary(wa_models,
             stars = TRUE,
             output = "markdown")


```


```{r Threshold Regressions}
# mod1 <- feols(tcr ~ asinh(fdi)|Year, odi_ind, vcov = "twoway")
# mod2 <- feols(tcr ~ asinh(fdi)|Year + industry, odi_ind, vcov = "twoway")
# mod3 <- feols(tcr ~ asinh(fdi_safe_us) + asinh(fdi_unsafe_us)|Year, odi_fdi_safety, vcov = "twoway")
# mod4 <- feols(tcr ~ asinh(fdi_safe_us) + asinh(fdi_unsafe_us)|Year + naics_3, odi_fdi_safety, vcov = "twoway")
# mod5 <- feols(tcr ~ asinh(fdi_safe_ind) + asinh(fdi_unsafe_ind)|Year, odi_fdi_safety, vcov = "twoway")
# mod6 <- feols(tcr ~ asinh(fdi_safe_ind) + asinh(fdi_unsafe_ind)|Year + naics_3, odi_fdi_safety, vcov = "twoway")
# mod7 <- feols(tcr ~ asinh(fdi_safe_plant) + asinh(fdi_unsafe_plant)|Year, odi_fdi_safety, vcov = "twoway")
# mod8 <- feols(tcr ~ asinh(fdi_safe_plant) + asinh(fdi_unsafe_plant)|Year + naics_3, odi_fdi_safety, vcov = "twoway")
# 
# models <- list(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8)
```

```{r Table 2}
# cm <- c("asinh(fdi)" = "$FDI^{total}$", "asinh(fdi_safe_us)" = "$FDI^{safe}$", "asinh(fdi_unsafe_us)" = "$FDI^{unsafe}$", "asinh(fdi_safe_ind)" = "$FDI^{safe}$", "asinh(fdi_unsafe_ind)" = "$FDI^{unsafe}$", "asinh(fdi_safe_plant)" = "$FDI^{safe}$", "asinh(fdi_unsafe_plant)" = "$FDI^{unsafe}$")
# 
# cap <- "Dependent variable: Total Case Rate (TCR)"
# 
# fn <- "Time fixed effects are included in all specifications. All independent variables are the inverse hyperbolic sine of the inward FDI position in the industry. The columns United States, Industry, and Plant represent different thresholds used to determine whether FDI is coming from safe or unsafe sources. Robust standard errors are clustered at the industry-year level."
# 
# gm <- tribble(~raw, ~clean, ~fmt,
#               "FE: naics_3", "Industry FE", "%.4f",
#               "FE: industry", "Industry FE", "%.4f",
#               "nobs", "Observations", "%.0f",
#               "r.squared", "R2", "%.2f")
# 
# 
# 
# tab <- modelsummary(models,
#              stars = TRUE,
#              coef_map = cm,
#              title = cap,
#              gof_omit = "R2 Within|R2 P|Log|AIC|BIC|Std|Year",
#              gof_map = gm,
#              coef_omit = "Intercept",
#              output = "latex",
#              escape = FALSE,
#              fmt = "%.4f") %>%
#   add_header_above(c(" " = 3, "United States" = 2, "Industry" = 2, "Plant" = 2)) %>%
#   add_footnote(fn, threeparttable = TRUE)
# 
# kableExtra::save_kable(tab, file = "../Output/table1.tex")
# 
# # modelsummary(models,
# #              stars = TRUE,
# #              gof_omit = "R2 Within|R2 P|Log|AIC|BIC|Std",
# #              output = "latex")
```

```{r Scatter Plots}
scatter_us <- ggplot(odi_fdi_safety, aes(x = fdi_unsafe_us, y = tcr)) + geom_point() + ylim(0,300) + geom_smooth(method = "lm")

scatter_ind <- ggplot(odi_fdi_safety, aes(x = fdi_unsafe_ind, y = tcr)) + geom_point() + ylim(0,300) + geom_smooth(method = "lm")

scatter_u_plant <- ggplot(odi_fdi_safety, aes(x = fdi_unsafe_plant, y = tcr)) + geom_point() + ylim(0,100) + xlim(0,100000) + geom_smooth(method = "lm")

scatter_s_plant <- ggplot(odi_fdi_safety, aes(x = fdi_safe_plant, y = tcr)) + geom_point(size = 1) + geom_point(aes(fdi_unsafe_plant, tcr), color = "red", size = 1) +  ylim(0,100) + xlim(0,100000) + geom_smooth(method = "lm")

# scatter_fdi <- ggplot(odi_ind, aes(x = fdi, y = tcr)) + geom_point(position = "dodge") + ylim(0,100) + xlim(0,100000) + geom_smooth(method = "lm")

show(scatter_s_plant)
```



```{r Test code}
int_breaks <- function(x, n = 5) {
  l <- pretty(x, n)
  l[abs(l %% 1) < .Machine$double.eps ^ 0.5] 
}

test <- odi_ind %>%
  group_by(Year) %>%
  summarise(
    inj = mean(tcr, na.rm = TRUE),
    fdi = mean(fdi, na.rm=TRUE)
  )

ggplot(test, aes(x = Year, y = fdi)) + geom_smooth(se=FALSE) + scale_x_continuous(breaks = int_breaks)
```














